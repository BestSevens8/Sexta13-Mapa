<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sexta-Feira 13 — Jantares</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#11131a;
      --card:#0f1118;
      --border:rgba(255,255,255,.10);
      --text:#eaeaea;
      --muted:rgba(255,255,255,.70);
      --accent:#d32f2f;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); }

    header{
      padding:14px 14px;
      background:var(--panel);
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .title{ font-weight:900; letter-spacing:.2px; }
    .subtitle{ font-size:12px; color:var(--muted); margin-top:2px; }
    .left{ display:flex; flex-direction:column; gap:8px; }
    .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    a.btn, button.btn{
      appearance:none; border:none; cursor:pointer; text-decoration:none;
      padding:10px 12px; border-radius:12px;
      background:rgba(255,255,255,.10); color:var(--text);
      border:1px solid var(--border);
      font-weight:800; font-size:13px;
    }
    a.btn:hover, button.btn:hover{ background:rgba(255,255,255,.14); }

    /* Tabs */
    .tabs{
      display:inline-flex;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      border-radius:14px;
      overflow:hidden;
    }
    .tab{
      padding:10px 12px;
      font-weight:900;
      font-size:13px;
      color:var(--muted);
      cursor:pointer;
      border:none;
      background:transparent;
    }
    .tab.active{
      color:var(--text);
      background:rgba(255,255,255,.12);
    }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; }

    /* Map view layout */
    #mapView main{
      height: calc(100vh - 86px);
      display:grid;
      grid-template-columns: 1fr 360px;
    }
    #map{ height:100%; width:100%; }
    aside{
      border-left:1px solid rgba(255,255,255,.08);
      background:var(--card);
      display:flex;
      flex-direction:column;
      min-width: 280px;
    }
    .aside-header{
      padding:12px;
      display:flex; justify-content:space-between; align-items:flex-end; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .aside-header h2{ margin:0; font-size:13px; opacity:.9; }
    .count{ font-size:12px; color:var(--muted); }

    .search{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .search input{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
      font-size:14px;
    }

    .list{
      list-style:none;
      margin:0;
      padding:10px;
      overflow:auto;
      flex:1;
    }
    .row{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      margin-bottom:8px;
      cursor:pointer;
    }
    .row:hover{ background:rgba(255,255,255,.08); }
    .row-top{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .row-title{ font-weight:900; font-size:13px; }
    .row-sub{ margin-top:4px; font-size:12px; color:var(--muted); line-height:1.25; }
    .badge{
      background:var(--accent);
      color:#fff;
      font-weight:900;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      flex:0 0 auto;
    }

    .foot{
      padding:10px 12px;
      font-size:12px;
      color:var(--muted);
      border-top:1px solid rgba(255,255,255,.08);
    }

    /* Pin numerado */
    .pin-number div{
      background: var(--accent);
      color:#fff;
      font-weight:900;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align:center;
      border: 2px solid #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,.45);
    }

    /* Popup */
    .popup{ color:#111; }
    .popup h3{ margin:0 0 6px; font-size:14px; }
    .popup .meta{ font-size:12px; margin:0 0 8px; }
    .popup .meta div{ margin:2px 0; }
    .popup a{ font-size:12px; }

    /* Gallery / Timeline containers */
    .page{
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }
    .cards{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @media (max-width: 980px){ .cards{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 520px){ .cards{ grid-template-columns: 1fr; } }

    .photo{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      border-radius:16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      cursor:pointer;
    }
    .photo img{
      width:100%;
      height: 170px;
      object-fit: cover;
      display:block;
      background:#000;
    }
    .photo .cap{
      padding:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
    .empty{
      border:1px dashed rgba(255,255,255,.20);
      border-radius:16px;
      padding:18px;
      color:var(--muted);
      background:rgba(255,255,255,.04);
    }

    .timeline{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .titem{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      border-radius:16px;
      padding:12px;
      cursor:pointer;
    }
    .titem:hover{ background:rgba(255,255,255,.08); }
    .titem .top{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .titem .h{
      font-weight:900;
      font-size:14px;
    }
    .titem .m{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }

    @media (max-width: 950px){
      #mapView main{ grid-template-columns: 1fr; grid-template-rows: 1fr 42vh; }
      aside{ border-left:none; border-top:1px solid rgba(255,255,255,.08); }
    }
    /* Stats cards */
.stats{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:10px;
  margin-top: 10px;
}
@media (max-width: 980px){ .stats{ grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 520px){ .stats{ grid-template-columns: 1fr; } }

.stat{
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
  border-radius:16px;
  padding:12px;
}
.stat .k{
  font-size:12px;
  color:var(--muted);
  font-weight:800;
}
.stat .v{
  margin-top:6px;
  font-size:18px;
  font-weight:1000;
  letter-spacing:.2px;
}
.stat .s{
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
  line-height:1.2;
}
    /* Melhor layout no telemóvel */
.header-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

@media (max-width: 768px){
  header{
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }

  .header-actions{
    justify-content: stretch;
  }

  .header-actions .btn{
    flex: 1 1 auto;
    text-align:center;
  }

  .header-stats{
    margin-top: 0;
    grid-template-columns: repeat(2, 1fr);
  }

  .header-stats .stat{
    padding: 10px;
  }

  /* Deixa o mapa maior no telemóvel */
  #mapView main{
    height: calc(100vh - 190px);
  }
}

@media (max-width: 420px){
  .header-stats{
    grid-template-columns: 1fr;
  }
}
  </style>
</head>

<body>
<header>
  <div class="left">
    <div>
      <div class="title">Sexta-Feira 13</div>
      <div class="subtitle">Mapa • Galeria • Timeline</div>
    </div>

    <!-- 4 quadrados (stats) -->
    <div class="stats header-stats" id="stats">
      <div class="stat">
        <div class="k">Jantares</div>
        <div class="v" id="stJantares">—</div>
        <div class="s">Total registado</div>
      </div>
      <div class="stat">
        <div class="k">Restaurantes</div>
        <div class="v" id="stRestaurantes">—</div>
        <div class="s">Diferentes</div>
      </div>
      <div class="stat">
        <div class="k">Cidades</div>
        <div class="v" id="stCidades">—</div>
        <div class="s">Diferentes</div>
      </div>
      <div class="stat">
        <div class="k">Melhor avaliado</div>
        <div class="v" id="stMelhor">—</div>
        <div class="s" id="stMelhorSub">—</div>
      </div>
    </div>

    <!-- 3 quadrados (tabs) -->
    <div class="tabs header-tabs" role="tablist" aria-label="Navegação">
      <button class="tab active" data-tab="mapView" role="tab" aria-selected="true">Mapa</button>
      <button class="tab" data-tab="galleryView" role="tab" aria-selected="false">Galeria</button>
      <button class="tab" data-tab="timelineView" role="tab" aria-selected="false">Timeline</button>
    </div>
  </div>

  <div class="right header-actions">
    <a class="btn" href="./editor.html">+ Novo Jantar (Editor)</a>
    <button class="btn" id="btnAll">Ver Portugal + ilhas</button>
  </div>
</header>


<!-- MAP VIEW -->
<section id="mapView" class="view active">
  <main>
    <div id="map"></div>
    <aside>
      <div class="aside-header">
        <h2>Jantares</h2>
        <div class="count" id="count">—</div>
      </div>
      <div class="search">
        <input id="search" type="search" placeholder="Procurar: cidade, restaurante, ano..." />
      </div>
      <ul class="list" id="list"></ul>
      <div class="foot">
        Dica: clica numa linha para focar o pin. A numeração é pela data (desde 2000).
      </div>
    </aside>
  </main>
</section>

<!-- GALLERY VIEW -->
<section id="galleryView" class="view">
  <div class="page">
    <h2 style="margin:0 0 10px;font-size:14px;opacity:.9;">Galeria</h2>
    <div id="galleryEmpty" class="empty" style="display:none;">
      Ainda não há fotos. No editor, adiciona links de fotos (1 por linha) no campo “Fotos”.
    </div>
    <div id="gallery" class="cards"></div>
  </div>
</section>

<!-- TIMELINE VIEW -->
<section id="timelineView" class="view">
  <div class="page">
    <h2 style="margin:0 0 10px;font-size:14px;opacity:.9;">Timeline (ordem cronológica)</h2>
    <div id="timelineEmpty" class="empty" style="display:none;">
      Ainda não há jantares válidos no jantares.json (precisam de data + lat + lng).
    </div>
    <div id="timeline" class="timeline"></div>
  </div>
</section>

<script>
  const $ = (id) => document.getElementById(id);

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function parseDateISO(s){
    const t = Date.parse(s);
    return Number.isFinite(t) ? t : null;
  }

  function fmtDatePT(iso){
    const [y,m,d] = String(iso).split("-");
    if(!y || !m || !d) return iso;
    return `${d}/${m}/${y}`;
  }

  // Tabs
  function setTab(id){
    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    $(id).classList.add("active");
    document.querySelectorAll(".tab").forEach(b => {
      const on = b.dataset.tab === id;
      b.classList.toggle("active", on);
      b.setAttribute("aria-selected", on ? "true" : "false");
    });
    // se entrar no mapa, força o Leaflet a recalcular o tamanho
    if(id === "mapView" && window._map) setTimeout(() => window._map.invalidateSize(), 50);
  }
  document.querySelectorAll(".tab").forEach(b => b.addEventListener("click", () => setTab(b.dataset.tab)));

  // Bounds: Portugal + Açores + Madeira (para “Ver tudo”)
  const portugalBounds = L.latLngBounds(
    [31.0, -31.7],
    [43.2,  -7.0]
  );

  // Mapa
  const map = L.map('map', {
    maxBounds: portugalBounds,
    maxBoundsViscosity: 1.0,
    minZoom: 3,
    maxZoom: 18
  });
  window._map = map;

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

// Ajuste inicial do mapa (desktop vs mobile)
if (window.innerWidth < 768) {
  // telemóvel: vista fixa para garantir Continente + Madeira + Açores
  map.setView([38.7, -16.5], 4);   // centro no Atlântico entre continente e Açores
} else {
  // desktop: encaixa nos limites
  map.fitBounds(portugalBounds, { padding: [20, 20] });
}


  const listEl = $("list");
  const countEl = $("count");
  const searchEl = $("search");
  const btnAll = $("btnAll");

  const galleryEl = $("gallery");
  const galleryEmpty = $("galleryEmpty");
  const timelineEl = $("timeline");
  const timelineEmpty = $("timelineEmpty");

  let entries = [];  // dados + numeração
  let markers = [];  // { entry, marker, li }

  function makeNumberIcon(n){
    return L.divIcon({
      className: "pin-number",
      html: `<div>${n}</div>`,
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    });
  }

  function popupHtml(e){
    const lines = [];
    lines.push(`<div class="popup">`);
    lines.push(`<h3>Jantar #${e.numero} — ${escapeHtml(e.cidade || "Local")}</h3>`);
    lines.push(`<div class="meta">`);
    if(e.data) lines.push(`<div><b>Data:</b> ${escapeHtml(fmtDatePT(e.data))}</div>`);
    if(e.restaurante && e.restaurante !== "—") lines.push(`<div><b>Restaurante:</b> ${escapeHtml(e.restaurante)}</div>`);
    if(e.morada && e.morada !== "—") lines.push(`<div><b>Morada:</b> ${escapeHtml(e.morada)}</div>`);
    const loc = [e.concelho, e.distrito].filter(x => x && x !== "—").join(" · ");
    if(loc) lines.push(`<div><b>Zona:</b> ${escapeHtml(loc)}</div>`);
    lines.push(`</div>`);

    const a = e.avaliacao || {};
    const hasStars = (a.comida||0) + (a.ambiente||0) + (a.experiencia||0) > 0;
    if(hasStars){
      lines.push(`<div class="meta">`);
      lines.push(`<div><b>⭐ Comida:</b> ${a.comida||0} &nbsp; <b>⭐ Ambiente:</b> ${a.ambiente||0} &nbsp; <b>⭐ Experiência:</b> ${a.experiencia||0}</div>`);
      lines.push(`</div>`);
    }

    if(e.mapsUrl){
      lines.push(`<div><a target="_blank" rel="noopener" href="${escapeHtml(e.mapsUrl)}">Abrir no Google Maps</a></div>`);
    }
    if(e.notas){
      lines.push(`<div class="meta" style="margin-top:8px;"><b>Notas:</b> ${escapeHtml(e.notas)}</div>`);
    }
    lines.push(`</div>`);
    return lines.join("");
  }

  function renderMapList(filtered){
    listEl.innerHTML = "";
    markers.forEach(m => map.removeLayer(m.marker));
    markers = [];

    filtered.forEach(e => {
      const marker = L.marker([e.lat, e.lng], { icon: makeNumberIcon(e.numero) }).addTo(map);
      marker.bindPopup(popupHtml(e), { maxWidth: 340 });

      const li = document.createElement("li");
      li.className = "row";
      li.innerHTML = `
        <div class="row-top">
          <div class="row-title">${escapeHtml(e.cidade || "Local")}</div>
          <div class="badge">#${e.numero}</div>
        </div>
        <div class="row-sub">
          ${e.data ? escapeHtml(fmtDatePT(e.data)) : ""}
          ${e.restaurante && e.restaurante !== "—" ? ` • ${escapeHtml(e.restaurante)}` : ""}
        </div>
      `;
      li.addEventListener("click", () => focusEntry(e, true));

      listEl.appendChild(li);
      markers.push({ entry:e, marker, li });
    });

    countEl.textContent = `${filtered.length} jantar(es)`;
  }

  function renderGallery(){
  galleryEl.innerHTML = "";
  const photos = [];

  entries.forEach(e => {
    (Array.isArray(e.fotos) ? e.fotos : []).forEach(url => {
      if(url && typeof url === "string"){
        photos.push({
          url,
          caption: `#${e.numero} • ${e.cidade || "Local"} • ${e.data ? fmtDatePT(e.data) : ""}`.trim(),
          entry: e
        });
      }
    });
  });

  if(!photos.length){
    galleryEmpty.style.display = "block";
    return;
  }
  galleryEmpty.style.display = "none";

  photos.forEach(p => {
    const card = document.createElement("div");
    card.className = "photo";
    card.innerHTML = `
      <img loading="lazy" src="${escapeHtml(p.url)}" alt="Foto" />
      <div class="cap">
        ${escapeHtml(p.caption)}
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <a class="btn" style="padding:8px 10px; border-radius:12px; display:inline-block;"
             target="_blank" rel="noopener" href="${escapeHtml(p.url)}">
             Abrir foto
          </a>

          <button class="btn"
            style="padding:8px 10px; border-radius:12px;"
            data-jantar="${p.entry.numero}">
            Ir para o jantar #${p.entry.numero}
          </button>
        </div>
      </div>
    `;

    // Botão "Ir para o jantar"
    card.querySelector('button[data-jantar]').addEventListener("click", () => {
      setTab("mapView");
      // Pequeno delay para o Leaflet reajustar o tamanho
      setTimeout(() => {
        focusEntry(p.entry, true);
      }, 80);
    });

    galleryEl.appendChild(card);
  });
}
  function renderTimeline(){
    timelineEl.innerHTML = "";
    if(!entries.length){
      timelineEmpty.style.display = "block";
      return;
    }
    timelineEmpty.style.display = "none";

    entries.forEach(e => {
      const item = document.createElement("div");
      item.className = "titem";
      item.innerHTML = `
        <div class="top">
          <div class="h">#${e.numero} — ${escapeHtml(e.cidade || "Local")}</div>
          <div class="badge">${e.data ? escapeHtml(fmtDatePT(e.data)) : ""}</div>
        </div>
        <div class="m">
          ${e.restaurante && e.restaurante !== "—" ? `<b>${escapeHtml(e.restaurante)}</b> • ` : ""}
          ${[e.concelho, e.distrito].filter(x => x && x !== "—").map(escapeHtml).join(" · ")}
        </div>
      `;
      item.addEventListener("click", () => {
        setTab("mapView");
        focusEntry(e, true);
      });
      timelineEl.appendChild(item);
    });
  }

  function applyFilter(){
    const q = searchEl.value.trim().toLowerCase();
    if(!q){
      renderMapList(entries);
      return;
    }
    const filtered = entries.filter(e => {
      const hay = [
        e.data, e.cidade, e.concelho, e.distrito, e.restaurante, e.morada,
        (e.pessoas||[]).join(" "),
        e.notas
      ].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(q);
    });
    renderMapList(filtered);
  }

  function focusEntry(e, openPopup){
    // encontra marker correspondente (se já renderizado)
    const m = markers.find(x => x.entry === e);
    map.setView([e.lat, e.lng], Math.max(map.getZoom(), 13), { animate:true });
    if(openPopup && m) m.marker.openPopup();
  }
  function renderStats(){
  // Total
  $("stJantares").textContent = String(entries.length);

  // Restaurantes diferentes (ignora "—")
  const restSet = new Set(
    entries.map(e => (e.restaurante || "").trim()).filter(r => r && r !== "—")
  );
  $("stRestaurantes").textContent = String(restSet.size);

  // Cidades diferentes (ignora "—")
  const cidSet = new Set(
    entries.map(e => (e.cidade || "").trim()).filter(c => c && c !== "—")
  );
  $("stCidades").textContent = String(cidSet.size);

  // Melhor avaliado (média de comida+ambiente+experiencia, ignora 0/0/0)
  let best = null; // { e, score }
  entries.forEach(e => {
    const a = e.avaliacao || {};
    const comida = Number(a.comida || 0);
    const ambiente = Number(a.ambiente || 0);
    const experiencia = Number(a.experiencia || 0);
    const sum = comida + ambiente + experiencia;

    // se não tiver avaliações, ignora
    if(sum <= 0) return;

    const score = sum / 3;
    if(!best || score > best.score) best = { e, score };
  });

  if(best){
    $("stMelhor").textContent = `#${best.e.numero}`;
    const nome = best.e.restaurante && best.e.restaurante !== "—"
      ? best.e.restaurante
      : (best.e.cidade || "Local");
    $("stMelhorSub").textContent = `${nome} • ${best.e.data ? fmtDatePT(best.e.data) : ""} • ${best.score.toFixed(1)}/5`;
  }else{
    $("stMelhor").textContent = "—";
    $("stMelhorSub").textContent = "Sem avaliações ainda";
  }
}

  async function load(){
    let data = [];
    try{
      const resp = await fetch("jantares.json", { cache: "no-store" });
      if(!resp.ok) throw new Error(`Falha a carregar jantares.json (${resp.status})`);
      data = await resp.json();
      if(!Array.isArray(data)) throw new Error("jantares.json não é um array");
    }catch(err){
      console.error(err);
      countEl.textContent = "Erro a ler jantares.json";
      timelineEmpty.style.display = "block";
      galleryEmpty.style.display = "block";
      return;
    }

    // ordenar por data (cronológico) + numerar
    const cleaned = data
      .map((e, idx) => ({...e, _idx: idx, _t: parseDateISO(e.data) }))
      .filter(e => Number.isFinite(e.lat) && Number.isFinite(e.lng) && (e._t !== null))
      .sort((a,b) => a._t - b._t || a._idx - b._idx)
      .map((e, i) => ({...e, numero: i+1}));

    entries = cleaned;

    renderMapList(entries);
    renderGallery();
    renderTimeline();
    renderStats();

  }

  // UI events
  searchEl.addEventListener("input", applyFilter);
  btnAll.addEventListener("click", () => map.fitBounds(portugalBounds, { padding:[20,20] }));

  load();
</script>
</body>
</html>
